{% extends 'resumes/base.html' %}

{% load static %}
{% load form_filters %}

{% block title %}上传与改写简历{% endblock %}
{% block content %}

<form method="post"
      action="{% url 'resumes:dashboard' %}"
      enctype="multipart/form-data"
      class="form mt-16">

  {% csrf_token %}

  {% if messages %}
    <ul class="alerts mt-12">
      {% for m in messages %}
        <li class="alert alert--{{ m.tags }}">{{ m }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  {% if form.errors %}
    <ul class="alerts mt-12">
      {% for field, errors in form.errors.items %}
        <li class="alert alert--error">
          <strong>{{ field }}</strong>: {{ errors|join:", " }}
        </li>
      {% endfor %}
      {% if form.non_field_errors %}
        <li class="alert alert--error">{{ form.non_field_errors|join:", " }}</li>
      {% endif %}
    </ul>
  {% endif %}

  <section class="grid">
    <!-- 左侧：岗位、JD、风格 + 上传文件 -->
    <div class="card">
      <h2 class="h3">岗位信息</h2>
      <p class="muted">填写应聘岗位与关键要求，选择输出风格。</p>

      <div class="form__group mt-12">
        <label class="form__label">应聘岗位</label>
        {{ form.target_role|add_class:"input" }}
      </div>

      <div class="form__group mt-12">
        <label class="form__label">岗位要求（JD）</label>
        {{ form.job_description|add_textarea_class:"input input--textarea" }}
      </div>

      <div class="form__group mt-12">
        <label class="form__label">风格</label>
        {{ form.tone|add_class:"select" }}
      </div>

      <hr class="divider mt-20 mb-16"/>

      <div class="form__group">
        <label class="form__label">上传简历（PDF / DOCX / TXT）</label>
        {{ form.resume_file|add_class:"input" }}
        <p class="hint">或在右侧粘贴纯文本</p>
      </div>
    </div>

    <!-- 右侧：原始文本粘贴区 -->
    <div class="card">
      <h2 class="h3">粘贴简历文本</h2>
      <p class="muted">如果不上传文件，可直接输入你的项目经历，会自动结合你的项目经历来整理</p>

      <div class="form mt-16">
        <div class="form__group">
          {{ form.raw_text|add_textarea_class:"input input--textarea input--tall" }}
        </div>
        <ul class="list mt-8">
          <li>支持中英文；建议删除联系方式等隐私信息后再提交。</li>
          <li>我们会在结果页展示改写后的全文，可复制保存。</li>
        </ul>
      </div>
    </div>
  </section>

  {# 进度条：放在 actions 之前 #}
  <div id="progress-container" class="progress hidden mt-20">
    <div id="progress-bar" class="progress__bar"></div>
  </div>

  {# ✅ 只保留这一组按钮 #}
  <div class="actions mt-20">
    <button id="submit-btn" class="btn btn--primary" type="submit">开始改写</button>
    <a class="btn btn--ghost" href="{% url 'resumes:dashboard' %}">重置</a>
  </div>

  {% if debug and debug.show %}
    <hr class="divider mt-20 mb-16"/>
    <div class="muted text-sm">
      <p><strong>Debug</strong></p>
      <p>path: {{ debug.path }}</p>
      <p>method: {{ debug.method }}</p>
      <p>view_name: {{ debug.view_name }}</p>
      <p>POST keys: {{ debug.post_keys|join:", " }}</p>
      <p>FILES: {{ debug.file_keys|join:", " }}</p>
    </div>
  {% endif %}

</form>

{# 进度条最简样式（如果你的全局样式里没有这些类，可以临时放这里） #}
<style>
  .progress { width:100%; height:8px; background:#eee; border-radius:4px; overflow:hidden; }
  .progress__bar { height:100%; width:0; background:#4f46e5; transition:width .3s ease; }
  .hidden { display:none; }
</style>

{# ✅ 把脚本放在 block content 内部，确保在 body 里执行 #}
<script>
document.addEventListener("DOMContentLoaded", function() {
  const form = document.querySelector("form");
  const progressContainer = document.getElementById("progress-container");
  const progressBar = document.getElementById("progress-bar");

  if (!form || !progressContainer || !progressBar) return;

  form.addEventListener("submit", function(e) {
    // 1) 阻止浏览器立刻导航
    e.preventDefault();

    // 2) 显示进度条并重置宽度
    progressContainer.classList.remove("hidden");
    progressBar.style.width = "0%";

    // 3) 先让浏览器完成一次绘制，再开始模拟进度与提交
    requestAnimationFrame(() => {
      let progress = 0;
      const interval = setInterval(() => {
        progress = Math.min(progress + Math.random() * 15, 95);
        progressBar.style.width = progress + "%";
      }, 300);

      // 4) 延迟一点点再真正提交（保证进度条至少出现一帧）
      setTimeout(() => {
        // 清理定时器不是必须的，因为页面会导航；但加上更干净
        clearInterval(interval);
        form.submit();
      }, 150); // 100~200ms 都可以
    });
  });
});
</script>
{% endblock %}
